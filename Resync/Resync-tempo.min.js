var Resync=function(k,z,d,r,D){function ga(v,a){var g=a;contract=T();obligation=contract.obligation;promise=contract.promise;null==g&&(g="fulfilled");g=z(g);switch(g){case "fulfilled":N(obligation,v);break;case "failed":O(obligation,v);break;case "aborted":P(promise,v);break;default:throw new d('Unsopported resolution: "'+g)+'"';}return promise}function ha(d){var a=x($);ra(a,"function"==typeof d?d:y(d));return a}function T(d){var a=x(aa);sa(a,y(d));return a}function Q(){var d=x(null);d.length=0;w(arguments,
function(a){L(d,a)});return d}function ta(d){for(var a=x(null),g=d.length>>>0,C=0;C<g;C++)C in d&&(a[C]=d[C]);a.length=g;return a}function F(d){var a=ua(va,ia(arguments,1));wa(a,"toStringTag",z(d));return a}r=function(){var d=k.create(null).$$;return{Unit:E,candy:f,$$:d}}();var E=r.Unit,f=r.candy,wa=r.$$,va=Spawn.beget,h=f.Function.lazyBind,ja=f.Function.bind,u=f.Function.call,U=f.Function.apply,ua=f.Function.spread,ja=f.Function.bind,t=f.Function.preload,ka=f.Function.defer,xa=f.Function.limit,R=
Array.from,ia=f.Array.slice,ya=f.Array.some,za=f.Array.splice,L=f.Array.push,J=f.Array.isArrayLike,ba=f.Array.toTruthTable,Aa=f.Array.without,Ba=f.Number.sign,M=f.Object.define,Ca=f.Reflect.getTypeOf,la=f.Reflect.getTagOf,H=f.Reflect.isLike,y=f.Reflect.own,w=f.Iterable.forEach,V=f.Iterable.map,x=k.create,W=k.keys,Da=k.getOwnPropertyNames,Ea=k.getOwnPropertyDescriptor,Fa=Number.toInt,Ga=Reflect.deleteProperty,N,O,ma,P,ca,na,da,oa={},pa=["pending","fulfilled","failed","aborted"],Ha=y({done:["fulfilled",
"failed","aborted"]}),$=function(){var f=E,a=createSecret();return F("Handler",f,{construct:function(g){if(null==this)throw new d("Cannot call `construct` on null or undefined.");var C=k(this);if(null==g)throw new d("Params expected.");if("function"!=typeof g&&(g=k(g).onOff,"function"!=typeof g))throw new d('Expected "onOff" param.');a(C).onOff=g},off:function(){if(null==this)throw new d("Cannot call `off` on null or undefined.");var g=k(this),g=a(g).onOff;if(!g)throw new d("Handler expected.");g()}})}(),
fa=function(){function f(a){function k(d,e,a){null!=l&&(S++,K[da(d)]&&(n++,s?(l[e]=a,l.length<e+1&&(l.length=e+1)):L(l,a)),n>=b?(I&&w(c,function(b){P(b,"Lost race.")}),N(v.obligation,R(l)),h()):S-n+b>p&&(m&&w(c,function(b){P(b,"Race failed.")}),O(v.obligation),h()))}function h(){l=null;w(Y,function(b){Z(b)})}a=y(a);var v=T({description:"PromiseManager"}),c=a.promises,p,e=a.states,b=a.count,s=!!a.maintainOrder,I=!!a.abortLosers,m=!!a.abortOnFailure,l=Q(),n=0,S=0,K=x(null),Y=Q();if(!J(c))throw new d("Array-like object expected.");
c=ta(c);p=c.length>>>0;s&&(l.length=p);if(void 0===e)a=1,K.fulfilled=!0;else if(J(e))a=e.length>>>0,w(e,function(b){b=z(b);if(!g[b])throw new d('Invalid state: "'+b+'"');K[b]=!0});else{e=z(e);a=1;if(!g[e])throw new d('Invalid state: "'+e+'"');K[e]=!0}void 0===b&&(b=1);b=Fa(b);-1==Ba(b)&&(b=p+b);0>b&&(b=0);if(0==p)0==b?N(v.obligation,[]):O(v.obligation);else for(var e=0,q;e<p;e++){q=c[e];H(q,"Contract")&&(q=q.promise);if(!H(q,"Promise"))throw new d("Promise expected.");!K.pending||1!=a&&"pending"!=
da(q)?L(Y,na(q,"done",t(k,q,e)).handler):k(q,e,void 0)}return v.promise}var a=E,g=ba(pa);return F("PromiseManager",a,{manage:f,all:function(d,a){return f({promises:d,states:a,count:-0,maintainOrder:!0,abortLosers:!1,abortOnFailure:!1})},some:function(d,a,g){return f({promises:d,states:a,count:void 0===g?1:g,maintainOrder:!1,abortLosers:!1,abortOnFailure:!1})},any:function(d,a){return f({promises:d,states:a,count:1,maintainOrder:!1,abortLosers:!1,abortOnFailure:!1}).get(0)}})}(),G=function(){function f(c){var d;
w(c,function(c){try{c()}catch(b){void 0===d&&(d=b)}});if(d)throw d;}function a(c,p,e){if(null==this)throw new d("Cannot call on null or undefined.");var b=k(this),s=A(b),I=s.validStates,m=s.pseudoStates,l=s.callbackMap;if(!s.isStateSwitcher)throw new d("Object has no defined states.");!0===c?(c=ha(function(){c&&(w(B(c).callbacks,function(b){var d=R(l[b.state]);d&&ya(d,function(c,s){if(b.callback===c)return za(d,s,1),!0})}),c=null)}),B(c).callbacks=Q()):!1===c&&(c=void 0);if(p&&"object"==typeof p)return w(W(p),
function(d){u(a,b,c,d,p[d])}),c;var n=p;if(J(n))return w(n,function(d){u(a,b,c,z(d),e)}),c;if(J(e))return w(e,function(s){if("function"!=typeof s)throw new d("Function expected in callbacks array.");u(a,b,c,n,s)}),c;n=z(n);if(!I[n]){if(m[n])return w(m[n],function(d){u(a,b,c,d,e)}),c;throw new d('Invalid state "'+n+'".');}if("function"!=typeof e)throw new d("Function expected for callback argument.");(I=n==s.state)&&ka(e);I&&!s.persistCallbacks||!s.switchesRemaining||(L(l[n]||(l[n]=Q()),e),c&&L(B(c).callbacks,
{state:n,callback:e}));if(c)return c}function g(d){var a=x(null);w(Da(d),function(e){var b=d[e],s;null!=b&&(s=R(b));s&&0<s.length&&(a[e]=s)});return a}var h=E,A=createSecret(),B=createSecret(),y={construct:function(c){if(null==c)throw new d("A StateSwitcher cannot be constructed without a params object.");if(!("states"in c))throw new d('StateSwitcher requires the "states" param.');if(!("initialState"in c))throw new d('StateSwitcher requires the "initialState" param.');if(null==this)throw new d("Cannot call construct on null or undefined.");
var a=k(this),e=A(a),b=h.construct,s="persistCallbacks"in c?c.persistCallbacks:!0,I="switchLimit"in c?c.switchLimit:Infinity,m=c.pseudoStates;"function"==typeof b&&u(b,a,c);e.isStateSwitcher=!0;e.validStates=ba(c.states);e.pseudoStates=null==m?null:g(m);e.callbackMap=x(null);e.persistCallbacks=!!s;e.switchesRemaining=Infinity===I?Infinity:I>>>0;u(y.switch,a,c.initialState);return a},switch:function(c){if(null==this)throw new d("Cannot call switch on null or undefined.");var a=k(this),a=A(a),e=a.validStates;
if(!a.isStateSwitcher)throw new d("Object has no defined states.");if(!a.switchesRemaining)return!1;c=z(c);if(!e[c])throw new d('Invalid state "'+c+'".');a.state=c;var e=a.callbackMap,b=e[c];--a.switchesRemaining?a.persistCallbacks||delete e[c]:(delete a.validStates,delete a.callbackMap);b&&ka(ja(f,null,b));return!0},addListener:t(a,!0),when:t(a,!1),getState:function(){if(null==this)throw new d("Cannot call getState on null or undefined.");var c=k(this),c=A(c),a=c.state;if(!c.isStateSwitcher)throw new d("Object has no defined states.");
return a}};return F("StateSwitcher",h,y)}(),aa=function(){function f(b,d,a){if(k(a)!==a)throw new D("Params object argument expected.");var e="description"in a?z(a.description):"";if(!("stateSwitcher"in a))throw new D("stateSwitcher param expected.");var l=k(this);b=b(l);var n=c.construct;"function"==typeof n&&u(n,l,a);M(l,"description",{value:e,enumerable:!1,writable:!1,configurable:!1});b.stateSwitcher=a.stateSwitcher;b.resolvables=ba(d);b.mediator=a.mediator;return l}function a(b){if(null==this)throw new d("Method cannot be called on null or undefined.");
var a=k(this);b=b(a).stateSwitcher;if(!b)throw new d("Object is not resolvable.");return qa(b)}function g(b){if(null==this)throw new d("Method cannot be called on null or undefined.");var a=k(this);b=b(a);a=b.mediator.value;if(!b.stateSwitcher)throw new d("Object is not resolvable.");return a}function C(b,a,c){if(null==this)throw new d("Method cannot be called on null or undefined.");var e=k(this);b=b(e);e=b.stateSwitcher;if(!e)throw new d("Object is not resolvable.");if(!b.resolvables[a])throw new d('Object cannot be resolved as "'+
a+'".');"pending"==qa(e)&&(b.mediator.value=c,Ia(e,a))}function A(b,a,c,e){if(null==this)throw new d("when cannot be called on null or undefined.");var l=c,f=e;e=k(this);var g=b(e),p=g.stateSwitcher;if(!p)throw new d("Object is not resolvable.");b=T({description:"> "+e.description});e=b.promise;var h=b.obligation,q,X,ea=a?Ja:Ka;if("object"==Ca(c))X=V(W(c),function(b){var a=c[b];return"function"==typeof a?Q(ea(p,b,function(){a(g.mediator.value,h)})):Aa(V(R(a),function(a){if(void 0!==a){if("function"!=
typeof a)throw new d("Function expected.");return ea(p,b,function(){q&&Z(q);a(g.mediator.value,h);stateSwitcherHandler=null})}}),void 0)});else{if(H(l,"String"))l=[z(l)];else if(!J(l))throw new d("String or array expected for resolution.");if("function"==typeof f)f=[f];else if(!J(f))throw new d("Function or array expected for callback.");X=V(l,function(b){return V(f,function(a){return ea(p,b,function(){q&&Z(q);a(g.mediator.value,h)})})})}return a?y({handler:q=ha(function(){q&&(w(X,function(b){w(b,
xa(Z,1))}),q=X=null)}),next:e}):e}var B=function(){var b=E,c=createSecret(),e=t(C,c,"fulfilled"),m=h(e),l=t(C,c,"failed"),p=h(l),S=t(A,c,!1);h(S);return F("Obligation",b,{construct:t(f,c,["fulfilled","failed"]),get state(){return u(a,this,c)},get value(){return u(g,this,c)},fulfill:e,fail:l,addListener:t(A,c,!0),when:S,link:function(b){if(null==this)throw new d("Cannot call link on null or undefined.");if(null==b)throw new d("Cannot call link with null or undefined.");var a=k(this);k(b);ca(b,y({fulfilled:function(b){m(a,
b)},failed:function(b){p(a,b)}}))}})}(),r=function(){var b=E,c=createSecret(),e=h(t(A,c,!1,"fulfilled")),m=h(B.fulfill);h(B.fail);var p=t(A,c,!1),k=h(p);return F("Promise",b,{construct:t(f,c,["aborted"]),get state(){return u(a,this,c)},get value(){return u(g,this,c)},abort:t(C,c,"aborted"),addListener:t(A,c,!0),when:p,then:function(b,a){if(null==this)throw new d("then cannot be called on null or undefined.");return k(this,y({fulfilled:b,failed:a}))},get:function(b){return e(this,function(a,c){m(c,
a[b])})},set:function(b,a){return e(this,function(c,d){m(d,c[b]=a)})},has:function K(b){return e(this,function(a,c){m(c,K(a,b))})},hasOwn:function Y(b){return e(this,function(a,c){m(c,Y(a,b))})},delete:function(b){return e(this,function(a,c){m(c,Ga(a,b))})},spreadTo:function(b){if("function"!=typeof b)throw new d("Function expected.");return e(this,function(a,c){m(c,U(b,null,a))})},call:function(b){var a=ia(arguments,1);return e(this,function(c,d){m(d,U(c,b,a))})},apply:function q(b,a){var c=la(a);
if("Arguments"!=c&&"Array"!=c)throw new d("Array or arguments object expected.");return e(this,function(c,d){m(d,q(c,b,a))})},invoke:function(){var b=arguments;return e(this,function(a,c){m(c,U(c,a,b))})},spread:function(b){var a=la(b);if("Arguments"!=a&&"Array"!=a)throw new d("Array or arguments object expected.");return e(this,function(a,c){m(c,U(c,a,b))})}})}(),c=E;createSecret();var p=h(B.construct),e=h(r.construct);N=h(B.fulfill);O=h(B.fail);ma=h(B.when);P=h(r.abort);ca=h(r.when);na=h(r.addListener);
da=h(Ea(r,"state").get);return F("Contract",c,{construct:function(b){if(null==this)throw new d("Cannot call construct on null or undefined.");void 0===b?b={}:"string"==typeof b&&(b={description:b});var a=k(this),f="description"in b?z(b.description):"",m=c.construct;"function"==typeof m&&u(m,a,b);M(a,"description",{value:f,enumerable:!1,writable:!1,configurable:!0});m={states:pa,pseudoStates:Ha,initialState:"pending"};b=x(G);La(b,y(m));var m=x(null),g=M,h={description:f,stateSwitcher:b,mediator:m},
v=x(B);p(v,h);g(a,"obligation",{value:v,enumerable:!1,writable:!1,configurable:!1});g=M;f={description:f,stateSwitcher:b,mediator:m};b=x(r);e(b,f);g(a,"promise",{value:b,enumerable:!1,writable:!1,configurable:!1});return a}})}();r=function(){function f(a,p,e,b,g,h){if(null==this)throw new d("when cannot be called on null or undefined.");var m=k(this),l,n,v=g,r,t=p(m).map;if(null==t)throw new d("when must be called on a"+("Obligor"==a?"n":"")+a+".");if(null==b)throw new d("Null or undefined not expected.");
H(b,"String")?l=[b]:H(b,"Array")?l=R(b):n=mapToObject(W(b),function(a){var c=b[a];"function"==typeof c?c=y({fulfilled:c}):null==c&&(c=x(null));return[a,k(c)]});if(l){"function"==typeof v?(v="fulfilled",r=g):(v=z(v),r=h);if("function"!=typeof r)throw new d("Function expected for callback argument.");n=x(null);w(l,function(a){var b=x(null);b[v]=r;n[a]=b})}var q=y({length:0}),u=oa;w(W(n),function(a){var b=t[a];if(null==b)throw new D('Contract not found: "'+a+'"');try{L(q,e(b,n[a]))}catch(c){u===oa&&
(u=c)}});if(u)throw u;return 0==q.length?ga():1==q.length?q[0]:fa.all(q)}function a(a,f,e,b,g,h){if(null==this)throw new d(e+" cannot be called on null or undefined.");a=k(this);f=f(a).map;if(null==f)throw new d(e+" must be called on an Obligor.");g=z(g);e=f[g];if(null==e)throw new D('Contract not found: "'+g+'"');return b(e,h)}var g=function(){var c=E,d=createSecret();return F("Obligor",c,{construct:function(a){if(null==a)throw new D("Params object is required.");var b=a.obligationMap;if(null==b)throw new D("obligationMap param is required.");
var f=k(this),g=d(f),h=c.construct;"function"==typeof h&&u(h,f,a);g.map=b;return f},when:t(f,"Obligor",d,ma),fulfill:t(a,"Obligor",d,"fulfill",N),fail:t(a,"Obligor",d,"fail",O)})}(),r=function(){var c=E,d=createSecret();return F("Promiser",c,{construct:function(a){if(null==a)throw new D("Params object is required.");var b=a.promiseMap;if(null==b)throw new D("promiseMap param is required.");var f=k(this),g=d(f),h=c.construct;"function"==typeof h&&u(h,f,a);g.map=b;return f},when:t(f,"Promiser",d,ca),
abort:t(a,"Promiser",d,"abort",P)})}(),A=E,B=h(g.construct),G=h(r.construct);return F("Contracter",A,{construct:function(a){if(null==a)throw new D("Params object is required.");var f=a.contracts;if(null==f)throw new D("contracts param is required.");if(!J(f))throw new d("contracts param must be an array-like object.");var e=k(this),b=A.construct;"function"==typeof b&&u(b,e,a);var g=x(null),h=x(null);w(f,function(a){a=z(a);var b=T({description:'Contracter: "'+a+'"'});g[a]=b.obligation;h[a]=b.promise});
M(e,"obligor",{value:B({obligationMap:g}),enumerable:!1,writable:!1,configurable:!1});M(e,"promiser",{value:G({promiseMap:h}),enumerable:!1,writable:!1,configurable:!1});return e}})}();var La=h(G.construct),Ka=h(G.when),qa=h(G.getState),Ia=h(G.switch),Ja=h(G.addListener),sa=h(aa.construct),Z=h($.off),ra=h($.construct);r=y({StateSwitcher:G,Contract:aa,Contracter:r,PromiseManager:fa,coerce:function(f){if(H(f,"Promise"))return f;H(f);f=f.promise;if(H(f,"Promise"))return f;throw new d("Contract has no promise property.");
},wrap:ga});f.mixin(r,fa);return r}(Object,String,TypeError,RangeError,Error);"object"==typeof module&&(null!=module&&"object"==typeof module.exports&&null!=module.exports)&&(module.exports=Resync);