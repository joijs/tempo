var Resync=function(m,y,h,xb,z){function ka(a,c){var f=c;contract=S();obligation=contract.obligation;promise=contract.promise;null==f&&(f="fulfilled");f=y(f);switch(f){case "fulfilled":K(obligation,a);break;case "failed":L(obligation,a);break;case "aborted":M(promise,a);break;default:throw new h('Unsopported resolution: "'+f)+'"';}return promise}function la(a){var c=p(T);Pa(c,"function"==typeof a?a:A(a));return c}function S(a){var c=p(U);Qa(c,A(a));return c}function N(){var a=p(null);a.length=0;r(arguments,
function(c){H(a,c)});return a}function w(a){var c=Ra(Sa,ma(arguments,1));Ta(c,"toStringTag",y(a));return c}var Ua=m.create(null).$$,v=v,d=d,Ta=Ua,Sa=Spawn.beget,j=d.Function.lazyBind,na=d.Function.bind,l=d.Function.call,V=d.Function.apply,Ra=d.Function.spread,na=d.Function.bind,n=d.Function.preload,oa=d.Function.defer,Va=d.Function.limit,O=Array.from,ma=d.Array.slice,Wa=d.Array.some,Xa=d.Array.splice,H=d.Array.push,D=d.Array.isArrayLike,ca=d.Array.toTruthTable,Ya=d.Array.without,Za=d.Number.sign,
I=d.Object.define,$a=d.Reflect.getTypeOf,pa=d.Reflect.getTagOf,C=d.Reflect.isLike,A=d.Reflect.own,r=d.Iterable.forEach,W=d.Iterable.map,p=m.create,X=m.keys,ab=m.getOwnPropertyNames,bb=m.getOwnPropertyDescriptor,cb=Number.toInt,db=Reflect.deleteProperty,K,L,qa,M,da,ra,ea,sa={},ta=["pending","fulfilled","failed","aborted"],eb=A({done:["fulfilled","failed","aborted"]}),T,fb=v,ua=createSecret();T=w("Handler",fb,{construct:function(a){if(null==this)throw new h("Cannot call `construct` on null or undefined.");
var c=m(this);if(null==a)throw new h("Params expected.");if("function"!=typeof a&&(a=m(a).onOff,"function"!=typeof a))throw new h('Expected "onOff" param.');ua(c).onOff=a},off:function(){if(null==this)throw new h("Cannot call `off` on null or undefined.");var a=m(this),a=ua(a).onOff;if(!a)throw new h("Handler expected.");a()}});var Y,$=function(a){function c(a,c,g){null!=d&&(l++,P[ea(a)]&&(j++,gb?(d[c]=g,d.length<c+1&&(d.length=c+1)):H(d,g)),j>=q?(hb&&r(e,function(a){M(a,"Lost race.")}),K(b.obligation,
O(d)),f()):l-j+q>k&&(m&&r(e,function(a){M(a,"Race failed.")}),L(b.obligation),f()))}function f(){d=null;r(z,function(a){Z(a)})}a=A(a);var b=S({description:"PromiseManager"}),e=a.promises,k,g=a.states,q=a.count,gb=!!a.maintainOrder,hb=!!a.abortLosers,m=!!a.abortOnFailure,d=N(),j=0,l=0,P=p(null),z=N();if(!D(e))throw new h("Array-like object expected.");a=e;for(var s=p(null),va=a.length>>>0,Q=0;Q<va;Q++)Q in a&&(s[Q]=a[Q]);s.length=va;e=s;k=e.length>>>0;if(void 0===g)a=1,P.fulfilled=!0;else if(D(g))a=
g.length>>>0,r(g,function(a){a=y(a);if(!wa[a])throw new h('Invalid state: "'+a+'"');P[a]=!0});else{g=y(g);a=1;if(!wa[g])throw new h('Invalid state: "'+g+'"');P[g]=!0}void 0===q&&(q=1);q=cb(q);-1==Za(q)&&(q=k+q);0>q&&(q=0);if(0==k)0==q?K(b.obligation,[]):L(b.obligation);else for(g=0;g<k;g++){s=e[g];C(s,"Contract")&&(s=s.promise);if(!C(s,"Promise"))throw new h("Promise expected.");P.pending&&(1==a||"pending"==ea(s))?c(s,g,void 0):H(z,ra(s,"done",n(c,s,g)).handler)}return b.promise},ib=v,wa=ca(ta);Y=
w("PromiseManager",ib,{manage:$,all:function(a,c){return $({promises:a,states:c,count:-0,maintainOrder:!0,abortLosers:!1,abortOnFailure:!1})},some:function(a,c,f){return $({promises:a,states:c,count:void 0===f?1:f,maintainOrder:!1,abortLosers:!1,abortOnFailure:!1})},any:function(a,c){return $({promises:a,states:c,count:1,maintainOrder:!1,abortLosers:!1,abortOnFailure:!1}).get(0)}});var B,jb=function(a){var c;r(a,function(a){try{a()}catch(b){void 0===c&&(c=b)}});if(c)throw c;},J=function(a,c,f){if(null==
this)throw new h("Cannot call on null or undefined.");var b=m(this),e=aa(b),k=e.validStates,g=e.pseudoStates,q=e.callbackMap;if(!e.isStateSwitcher)throw new h("Object has no defined states.");!0===a?(a=la(function(){a&&(r(fa(a).callbacks,function(a){var b=O(q[a.state]);b&&Wa(b,function(c,f){if(a.callback===c)return Xa(b,f,1),!0})}),a=null)}),fa(a).callbacks=N()):!1===a&&(a=void 0);if(c&&"object"==typeof c)return r(X(c),function(f){l(J,b,a,f,c[f])}),a;var d=c;if(D(d))return r(d,function(c){l(J,b,a,
y(c),f)}),a;if(D(f))return r(f,function(c){if("function"!=typeof c)throw new h("Function expected in callbacks array.");l(J,b,a,d,c)}),a;d=y(d);if(!k[d]){if(g[d])return r(g[d],function(c){l(J,b,a,c,f)}),a;throw new h('Invalid state "'+d+'".');}if("function"!=typeof f)throw new h("Function expected for callback argument.");(k=d==e.state)&&oa(f);if((!k||e.persistCallbacks)&&e.switchesRemaining)H(q[d]||(q[d]=N()),f),a&&H(fa(a).callbacks,{state:d,callback:f});if(a)return a},xa=v,aa=createSecret(),fa=
createSecret(),ya={construct:function(a){if(null==a)throw new h("A StateSwitcher cannot be constructed without a params object.");if(!("states"in a))throw new h('StateSwitcher requires the "states" param.');if(!("initialState"in a))throw new h('StateSwitcher requires the "initialState" param.');if(null==this)throw new h("Cannot call construct on null or undefined.");var c=m(this),f=aa(c),b=xa.construct,e="persistCallbacks"in a?a.persistCallbacks:!0,k="switchLimit"in a?a.switchLimit:Infinity,g=a.pseudoStates;
"function"==typeof b&&l(b,c,a);f.isStateSwitcher=!0;f.validStates=ca(a.states);if(null==g)b=null;else{var d=p(null);r(ab(g),function(a){var b=g[a],c;null!=b&&(c=O(b));c&&0<c.length&&(d[a]=c)});b=d}f.pseudoStates=b;f.callbackMap=p(null);f.persistCallbacks=!!e;f.switchesRemaining=Infinity===k?Infinity:k>>>0;l(ya.switch,c,a.initialState);return c},"switch":function(a){if(null==this)throw new h("Cannot call switch on null or undefined.");var c=m(this),c=aa(c),f=c.validStates;if(!c.isStateSwitcher)throw new h("Object has no defined states.");
if(!c.switchesRemaining)return!1;a=y(a);if(!f[a])throw new h('Invalid state "'+a+'".');c.state=a;var f=c.callbackMap,b=f[a];--c.switchesRemaining?c.persistCallbacks||delete f[a]:(delete c.validStates,delete c.callbackMap);b&&oa(na(jb,null,b));return!0},addListener:n(J,!0),when:n(J,!1),getState:function(){if(null==this)throw new h("Cannot call getState on null or undefined.");var a=m(this),a=aa(a),c=a.state;if(!a.isStateSwitcher)throw new h("Object has no defined states.");return c}};B=w("StateSwitcher",
xa,ya);var U,za=function(a,c,f){if(m(f)!==f)throw new z("Params object argument expected.");var b="description"in f?y(f.description):"";if(!("stateSwitcher"in f))throw new z("stateSwitcher param expected.");var e=m(this);a=a(e);var k=ga.construct;"function"==typeof k&&l(k,e,f);I(e,"description",{value:b,enumerable:!1,writable:!1,configurable:!1});a.stateSwitcher=f.stateSwitcher;a.resolvables=ca(c);a.mediator=f.mediator;return e},Ba=function(a){if(null==this)throw new h("Method cannot be called on null or undefined.");
var c=m(this);a=a(c).stateSwitcher;if(!a)throw new h("Object is not resolvable.");return Aa(a)},Ca=function(a){if(null==this)throw new h("Method cannot be called on null or undefined.");var c=m(this);a=a(c);c=a.mediator.value;if(!a.stateSwitcher)throw new h("Object is not resolvable.");return c},ha=function(a,c,f){if(null==this)throw new h("Method cannot be called on null or undefined.");var b=m(this);a=a(b);b=a.stateSwitcher;if(!b)throw new h("Object is not resolvable.");if(!a.resolvables[c])throw new h('Object cannot be resolved as "'+
c+'".');"pending"==Aa(b)&&(a.mediator.value=f,kb(b,c))},R=function(a,c,f,b){if(null==this)throw new h("when cannot be called on null or undefined.");var e=f,k=b;b=m(this);var g=a(b),d=g.stateSwitcher;if(!d)throw new h("Object is not resolvable.");a=S({description:"> "+b.description});b=a.promise;var j=a.obligation,l,n,p=c?lb:mb;if("object"==$a(f))n=W(X(f),function(a){var b=f[a];return"function"==typeof b?N(p(d,a,function(){b(g.mediator.value,j)})):Ya(W(O(b),function(b){if(void 0!==b){if("function"!=
typeof b)throw new h("Function expected.");return p(d,a,function(){l&&Z(l);b(g.mediator.value,j);stateSwitcherHandler=null})}}),void 0)});else{if(C(e,"String"))e=[y(e)];else if(!D(e))throw new h("String or array expected for resolution.");if("function"==typeof k)k=[k];else if(!D(k))throw new h("Function or array expected for callback.");n=W(e,function(a){return W(k,function(b){return p(d,a,function(){l&&Z(l);b(g.mediator.value,j)})})})}return c?A({handler:l=la(function(){l&&(r(n,function(a){r(a,Va(Z,
1))}),l=n=null)}),next:b}):b},x,nb=v,E=createSecret(),Da=n(ha,E,"fulfilled"),ob=j(Da),Ea=n(ha,E,"failed"),pb=j(Ea),Fa=n(R,E,!1);j(Fa);x=w("Obligation",nb,{construct:n(za,E,["fulfilled","failed"]),get state(){return l(Ba,this,E)},get value(){return l(Ca,this,E)},fulfill:Da,fail:Ea,addListener:n(R,E,!0),when:Fa,link:function(a){if(null==this)throw new h("Cannot call link on null or undefined.");if(null==a)throw new h("Cannot call link with null or undefined.");var c=m(this);m(a);da(a,A({fulfilled:function(a){ob(c,
a)},failed:function(a){pb(c,a)}}))}});var F,qb=v,G=createSecret(),t=j(n(R,G,!1,"fulfilled")),u=j(x.fulfill);j(x.fail);var Ga=n(R,G,!1),rb=j(Ga);F=w("Promise",qb,{construct:n(za,G,["aborted"]),get state(){return l(Ba,this,G)},get value(){return l(Ca,this,G)},abort:n(ha,G,"aborted"),addListener:n(R,G,!0),when:Ga,then:function(a,c){if(null==this)throw new h("then cannot be called on null or undefined.");return rb(this,A({fulfilled:a,failed:c}))},get:function(a){return t(this,function(c,f){u(f,c[a])})},
set:function(a,c){return t(this,function(f,b){u(b,f[a]=c)})},has:function c(f){return t(this,function(b,e){u(e,c(b,f))})},hasOwn:function f(b){return t(this,function(e,k){u(k,f(e,b))})},"delete":function(f){return t(this,function(b,e){u(e,db(b,f))})},spreadTo:function(f){if("function"!=typeof f)throw new h("Function expected.");return t(this,function(b,e){u(e,V(f,null,b))})},call:function(f){var b=ma(arguments,1);return t(this,function(e,k){u(k,V(e,f,b))})},apply:function b(e,k){var g=pa(k);if("Arguments"!=
g&&"Array"!=g)throw new h("Array or arguments object expected.");return t(this,function(g,d){u(d,b(g,e,k))})},invoke:function(){var b=arguments;return t(this,function(e,k){u(k,V(k,e,b))})},spread:function(b){var e=pa(b);if("Arguments"!=e&&"Array"!=e)throw new h("Array or arguments object expected.");return t(this,function(e,g){u(g,V(g,e,b))})}});var ga=v;createSecret();var sb=j(x.construct),tb=j(F.construct);K=j(x.fulfill);L=j(x.fail);qa=j(x.when);M=j(F.abort);da=j(F.when);ra=j(F.addListener);ea=
j(bb(F,"state").get);U=w("Contract",ga,{construct:function(b){if(null==this)throw new h("Cannot call construct on null or undefined.");void 0===b?b={}:"string"==typeof b&&(b={description:b});var e=m(this),d="description"in b?y(b.description):"",g=ga.construct;"function"==typeof g&&l(g,e,b);I(e,"description",{value:d,enumerable:!1,writable:!1,configurable:!0});g={states:ta,pseudoStates:eb,initialState:"pending"};b=p(B);ub(b,A(g));var g=p(null),q={description:d,stateSwitcher:b,mediator:g},j=p(x);sb(j,
q);I(e,"obligation",{value:j,enumerable:!1,writable:!1,configurable:!1});d={description:d,stateSwitcher:b,mediator:g};b=p(F);tb(b,d);I(e,"promise",{value:b,enumerable:!1,writable:!1,configurable:!1});return e}});var Ha,Ia=function(b,e,d,g,j,l){if(null==this)throw new h("when cannot be called on null or undefined.");var n=m(this),v,t,u=j,w,B=e(n).map;if(null==B)throw new h("when must be called on a"+("Obligor"==b?"n":"")+b+".");if(null==g)throw new h("Null or undefined not expected.");C(g,"String")?
v=[g]:C(g,"Array")?v=O(g):t=mapToObject(X(g),function(b){var e=g[b];"function"==typeof e?e=A({fulfilled:e}):null==e&&(e=p(null));return[b,m(e)]});if(v){"function"==typeof u?(u="fulfilled",w=j):(u=y(u),w=l);if("function"!=typeof w)throw new h("Function expected for callback argument.");t=p(null);r(v,function(b){var e=p(null);e[u]=w;t[b]=e})}var x=A({length:0}),s=sa;r(X(t),function(b){var e=B[b];if(null==e)throw new z('Contract not found: "'+b+'"');try{H(x,d(e,t[b]))}catch(g){s===sa&&(s=g)}});if(s)throw s;
return 0==x.length?ka():1==x.length?x[0]:Y.all(x)},ia=function(b,e,d,g,j,l){if(null==this)throw new h(d+" cannot be called on null or undefined.");b=m(this);e=e(b).map;if(null==e)throw new h(d+" must be called on an Obligor.");j=y(j);d=e[j];if(null==d)throw new z('Contract not found: "'+j+'"');return g(d,l)},Ja,Ka=v,ba=createSecret();Ja=w("Obligor",Ka,{construct:function(b){if(null==b)throw new z("Params object is required.");var e=b.obligationMap;if(null==e)throw new z("obligationMap param is required.");
var d=m(this),g=ba(d),h=Ka.construct;"function"==typeof h&&l(h,d,b);g.map=e;return d},when:n(Ia,"Obligor",ba,qa),fulfill:n(ia,"Obligor",ba,"fulfill",K),fail:n(ia,"Obligor",ba,"fail",L)});var La,Ma=v,ja=createSecret();La=w("Promiser",Ma,{construct:function(b){if(null==b)throw new z("Params object is required.");var e=b.promiseMap;if(null==e)throw new z("promiseMap param is required.");var d=m(this),g=ja(d),h=Ma.construct;"function"==typeof h&&l(h,d,b);g.map=e;return d},when:n(Ia,"Promiser",ja,da),
abort:n(ia,"Promiser",ja,"abort",M)});var Na=v,vb=j(Ja.construct),wb=j(La.construct);Ha=w("Contracter",Na,{construct:function(b){if(null==b)throw new z("Params object is required.");var e=b.contracts;if(null==e)throw new z("contracts param is required.");if(!D(e))throw new h("contracts param must be an array-like object.");var d=m(this),g=Na.construct;"function"==typeof g&&l(g,d,b);var j=p(null),n=p(null);r(e,function(b){b=y(b);var d=S({description:'Contracter: "'+b+'"'});j[b]=d.obligation;n[b]=d.promise});
I(d,"obligor",{value:vb({obligationMap:j}),enumerable:!1,writable:!1,configurable:!1});I(d,"promiser",{value:wb({promiseMap:n}),enumerable:!1,writable:!1,configurable:!1});return d}});var ub=j(B.construct),mb=j(B.when),Aa=j(B.getState),kb=j(B.switch),lb=j(B.addListener),Qa=j(U.construct),Z=j(T.off),Pa=j(T.construct),Oa=A({StateSwitcher:B,Contract:U,Contracter:Ha,PromiseManager:Y,coerce:function(b){if(C(b,"Promise"))return b;C(b);b=b.promise;if(C(b,"Promise"))return b;throw new h("Contract has no promise property.");
},wrap:ka});d.mixin(Oa,Y);return Oa}(Object,String,TypeError,RangeError,Error);"object"==typeof module&&(null!=module&&"object"==typeof module.exports&&null!=module.exports)&&(module.exports=Resync);